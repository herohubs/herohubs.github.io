---
import menuJson from "@/config/menu.json";
import { getSinglePage } from "@/lib/contentParser.astro";

interface ChildNavigationLink {
  name: string;
  url: string;
}

interface NavigationLink {
  name: string;
  url: string;
  hasChildren?: boolean;
  children?: ChildNavigationLink[];
}

const menu: { main: NavigationLink[] } = menuJson;
const { pathname } = Astro.url;

const posts = await getSinglePage("posts");

// Extracting unique categories from posts
const uniqueCategories: string[] = [
  ...new Set(posts.flatMap((post: any) => post.data.categories)),
];

const categories: NavigationLink[] = uniqueCategories.map(
  (category: string) => ({
    name: category,
    url: `/categories/${category?.toLowerCase().replace(/\s+/g, "-")}`,
  }),
);

// Constructing combinedMenu
const combinedMenu: NavigationLink[] = [];

// Adding the first item of main
combinedMenu.push(menu.main[0]);

// Adding the rest of the items from main excluding the first one
if (!pathname.startsWith("/categories/")) {
  combinedMenu.push(...menu.main.slice(1));
}

// Adding all categories
if (
  pathname.startsWith(menu.main[0].url) &&
  !menu.main.slice(1).some((item) => pathname.startsWith(item.url))
) {
  combinedMenu.push(...categories);
}


---

<header class={`header mt-8 pb-3 pt-12`}>
  <nav class="navbar container text-center md:text-left">
    <!-- navbar toggler -->
    <input id="nav-toggle" type="checkbox" class="hidden" />
    <label
      for="nav-toggle"
      class="order-3 cursor-pointer rounded border border-border p-6 lg:p-9 p-4 inline-flex items-center lg:order-1 md:hidden">
      <svg
        id="show-button"
        class="mr-1 h-4 w-4 fill-current block"
        viewBox="0 0 20 20"
      >
        <title>Menu Open</title>
        <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z"></path>
      </svg>
      <svg
        id="hide-button"
        class="mr-1 h-4 w-4 fill-current hidden"
        viewBox="0 0 20 20"
      >
        <title>Menu Close</title>
        <polygon
          points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
          transform="rotate(45 10 10)"></polygon>
      </svg>
      Menu
    </label>
    <!-- /navbar toggler -->

    {
      pathname !== "/" && (
        <div class="hidden text-center md:block">
          <a
            class="mb-12  inline-flex items-center text-primary hover:underline"
            href="/"
          >
            <svg
              class="mr-2"
              width="21"
              height="16"
              viewBox="0 0 21 16"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M.292892 7.29289c-.3905235.39053-.3905235 1.02369.0 1.41422L6.65685 15.0711C7.04738 15.4616 7.68054 15.4616 8.07107 15.0711 8.46159 14.6805 8.46159 14.0474 8.07107 13.6569L2.41421 8 8.07107 2.34315C8.46159 1.95262 8.46159 1.31946 8.07107.928932 7.68054.538408 7.04738.538408 6.65685.928932L.292892 7.29289zM21 7H1V9H21V7z"
                fill="currentcolor"
              />
            </svg>
            Back to Home
          </a>
        </div>
      )
    }
<div class="hidden md:flex flex-col md:flex-row"></div>
<ul
  id="nav-menu"
  class="navbar-nav order-3 w-full hidden flex-col items-center justify-center space-y-2 md:order-1 md:flex md:w-auto md:flex-row md:space-y-0 md:space-x-2"
>
  {combinedMenu.map((menu) => (
    <>
      {!menu.url.startsWith("/categories/") &&
        (!menu.url.startsWith("/ui-kit") || import.meta.env.DEV) && (
          <li class="nav-item">
            <a
              href={menu.url}
              class={`nav-link inline-block ${
                (pathname === `${menu.url}/` || pathname === menu.url)
                  ? "nav-link-active"
                  : ""
              } ${
                menu.url.startsWith("/ui-kit") ? "text-red-600" : ""
              }`}
            >
              {menu.name}
            </a>
          </li>
        )}
    </>
  ))}
</ul>

<ul
id="nav-menu"
  class="navbar-nav order-3 w-full hidden flex-col items-center justify-center space-y-2 md:flex md:w-auto md:flex-row md:space-y-0 md:space-x-2 md:mt-6 mt-0"
>
  {combinedMenu.map((menu) => (
    <>
      {menu.url.startsWith("/categories/") && (
        <li class="nav-item">
          <a
            href={menu.url}
            class={`nav-link inline-block ${
              (pathname === `${menu.url}/` || pathname === menu.url)
                ? "nav-link-active"
                : ""
            }`}
          >
            {menu.name}
          </a>
        </li>
      )}
    </>
  ))}
</ul>
</div>

  </nav>
</header>
