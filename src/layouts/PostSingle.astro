---
import mainConfig from '@/config/main-config.json';
import Disqus from '@/helpers/Disqus';
import { getSinglePage } from '@/lib/contentParser.astro';
import dateFormat from '@/lib/utils/dateFormat';
import readingTime from '@/lib/utils/readingTime';
import similarItems from '@/lib/utils/similarItems';
import { humanize, markdownify, slugify } from '@/lib/utils/textConverter';
import { render } from 'astro:content';
import ImageMod from './components/ImageMod.astro';
import Post from './components/Post.astro';
import { loadLocalizedConfig } from '@/lib/utils/lang';
const { post, lang } = Astro.props;
const posts = await getSinglePage('posts', lang);
let similarPosts = similarItems(post, posts);
const { Content } = await render(post);
const { title, categories, image, date } = post.data;
similarPosts = similarPosts.sort((a, b) => {
  const dateA = new Date(a.data.date);
  const dateB = new Date(b.data.date);
  return dateB.getTime() - dateA.getTime();
});
const i18n: any = await loadLocalizedConfig(lang, 'i18n');
const currentPath = Astro.url.pathname;
const englishUrl = currentPath.replace(/^\/it/, '/en');
const italianUrl = currentPath.replace(/^\/en/, '/it');
---

<section class="pt-8 pb-6 md:pt-20">
  <div class="container">
    <div class="row">
      <div class="mx-auto lg:col-10">
        <div class="mb-12 flex items-center justify-between w-full gap-4">
          <button
            class="inline-flex items-center px-3 py-1 text-base font-medium text-primary hover:underline rounded"
            onclick="if (document.referrer.includes('herohubs')) { window.history.back() } else { window.location.href='/' }"
          >
            <svg class="mr-2" width="21" height="16" viewBox="0 0 21 16" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M.292892 7.29289c-.3905235.39053-.3905235 1.02369.0 1.41422L6.65685 15.0711C7.04738 15.4616 7.68054 15.4616 8.07107 15.0711 8.46159 14.6805 8.46159 14.0474 8.07107 13.6569L2.41421 8 8.07107 2.34315C8.46159 1.95262 8.46159 1.31946 8.07107.928932 7.68054.538408 7.04738.538408 6.65685.928932L.292892 7.29289zM21 7H1V9H21V7z"
                fill="currentcolor"></path>
            </svg>
            <span>{i18n.exit}</span>
          </button>

          <div class="flex items-center space-x-2">
            <span class="text-gray-600 text-base mr-2">{i18n.langSwitcher.label}:</span>

            {
              lang !== 'en' && (
                <button
                  class="inline-flex items-center px-2 py-1 text-base font-medium text-primary hover:underline rounded"
                  onclick={`window.location.href='${englishUrl}'`}
                >
                  {i18n.langSwitcher.en}
                  <span class="ml-1 w-3 h-3 rounded-full bg-primary inline-block" />
                </button>
              )
            }

            {
              lang !== 'it' && (
                <button
                  class="inline-flex items-center px-2 py-1 text-base font-medium text-primary hover:underline rounded"
                  onclick={`window.location.href='${italianUrl}'`}
                >
                  {i18n.langSwitcher.it}
                  <span class="ml-1 w-3 h-3 rounded-full bg-primary inline-block" />
                </button>
              )
            }
          </div>
        </div>

        <!-- <button
          class="mb-12 inline-flex items-center text-primary hover:underline"
          onclick="if (document.referrer.includes('localhost')) { window.history.back() } else { window.location.href='/' }"
        >
          <svg class="mr-2" width="21" height="16" viewBox="0 0 21 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M.292892 7.29289c-.3905235.39053-.3905235 1.02369.0 1.41422L6.65685 15.0711C7.04738 15.4616 7.68054 15.4616 8.07107 15.0711 8.46159 14.6805 8.46159 14.0474 8.07107 13.6569L2.41421 8 8.07107 2.34315C8.46159 1.95262 8.46159 1.31946 8.07107.928932 7.68054.538408 7.04738.538408 6.65685.928932L.292892 7.29289zM21 7H1V9H21V7z"
              fill="currentcolor"></path>
          </svg>
          <span id="back-label">{i18n.exit}</span>
        </button> -->

        <article>
          {image && <ImageMod class="w-full" src={image} height={500} width={1000} alt={title} loading="eager" />}
          <h1 set:html={markdownify(title)} class="h2 mt-12" />
          <ul class="mt-4 mb-8 text-text">
            <li class="mb-2 mr-4 inline-block">
              <ul>
                {
                  categories.map((category: any) => (
                    <li class="inline-block">
                      <a href={`/${lang}/categories/${slugify(category)}`} class="mr-3 text-primary">
                        {humanize(category)}
                      </a>
                    </li>
                  ))
                }
                |
              </ul>
            </li>
            <li class="mb-2 mr-4 inline-block">
              <span class="mr-2 inline-block">
                {
                  dateFormat(date, 'MMMM yyyy', lang).charAt(0).toUpperCase() +
                    dateFormat(date, 'MMMM yyyy', lang).slice(1)
                }
              </span>{' '}
              |
            </li>
            <li class="mb-2 mr-4 inline-block">{readingTime(post.body, lang)}</li>
          </ul>
          <div class="content text-justify">
            <Content />
          </div>
        </article>

        {mainConfig.disqus.enable && <Disqus className="mt-20" client:load />}
      </div>
    </div>

    <div class="pt-12">
      <h2 class="h2 text-center">{i18n.related_posts}</h2>
      <div class="row gy-4 mt-12 justify-center">
        {similarPosts.slice(0, 9).map((post) => <Post className="col-12 md:col-4" post={post} lang={lang} />)}
      </div>
    </div>
  </div>
</section>
